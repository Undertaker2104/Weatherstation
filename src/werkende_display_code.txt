#include <Arduino.h>
#include <Wire.h>
#include <SPI.h>
#include <TFT_eSPI.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>

#define BME_ADDR 0x76 // 0x76 if SDO=GND, 0x77 if SDO=3V3
#define SDA_PIN 21
#define SCL_PIN 22

TFT_eSPI tft;        // Uses pins from build_flags
Adafruit_BME280 bme; // I2C instance

// Quick & tiny I2C scan for debugging
void i2cScan()
{
  Serial.println("Scanning I2C...");
  byte found = 0;
  for (byte addr = 1; addr < 127; addr++)
  {
    Wire.beginTransmission(addr);
    if (Wire.endTransmission() == 0)
    {
      Serial.printf("  Found device at 0x%02X\n", addr);
      found++;
    }
  }
  if (!found)
    Serial.println("  No I2C devices found.");
  Serial.println();
}

void drawStaticUI()
{
  tft.fillScreen(TFT_BLACK);
  tft.setTextColor(TFT_WHITE, TFT_BLACK);
  tft.setTextDatum(TL_DATUM);

  tft.setTextFont(2);
  tft.drawString("ESP32 + ILI9341 + BME280", 10, 8);
  tft.drawLine(10, 28, tft.width() - 10, 28, TFT_DARKGREY);

  // Labels
  tft.setTextFont(2);
  tft.drawString("Temp:", 10, 50);
  tft.drawString("Hum :", 10, 80);
  tft.drawString("Press:", 10, 110);

  // Data boxes
  tft.drawRect(70, 46, 150, 24, TFT_DARKGREY);
  tft.drawRect(70, 76, 150, 24, TFT_DARKGREY);
  tft.drawRect(70, 106, 150, 24, TFT_DARKGREY);
}

void drawValue(int x, int y, const String &s)
{
  // Erase area and redraw text to avoid flicker
  tft.fillRect(x, y, 146, 20, TFT_BLACK);
  tft.setTextFont(2);
  tft.setTextColor(TFT_GREEN, TFT_BLACK);
  tft.drawString(s, x + 2, y + 2);
}

void setup()
{
  Serial.begin(115200);
  delay(200);
  Serial.println("\nBooting...");

  // --- TFT ---
  tft.init();
  tft.setRotation(1); // landscape
  drawStaticUI();

  // --- I2C + BME280 ---
  Wire.begin(SDA_PIN, SCL_PIN);
  Wire.setClock(100000); // reliable; can raise to 400000 later
  i2cScan();

  if (!bme.begin(BME_ADDR, &Wire))
  {
    tft.setTextColor(TFT_RED, TFT_BLACK);
    tft.drawString("BME280 not found!", 10, 150);
    tft.drawString("Check wiring/address.", 10, 170);
    Serial.println("ERROR: BME280 not found. If SDO=3V3 use 0x77.");
    // Keep running so you can rewire without reflashing
  }
  else
  {
    // Optional: tune sampling
    bme.setSampling(
        Adafruit_BME280::MODE_NORMAL,
        Adafruit_BME280::SAMPLING_X2,  // temperature
        Adafruit_BME280::SAMPLING_X16, // pressure
        Adafruit_BME280::SAMPLING_X1,  // humidity
        Adafruit_BME280::FILTER_X16,
        Adafruit_BME280::STANDBY_MS_500);
    tft.setTextColor(TFT_CYAN, TFT_BLACK);
    tft.drawString("BME280 OK", 10, 150);
  }
}

uint32_t last = 0;

void loop()
{
  if (millis() - last >= 1000)
  { // update once per second
    last = millis();

    // If bme wasn't found, reads return NAN; we’ll still attempt and show blanks
    float t = bme.readTemperature();      // °C
    float h = bme.readHumidity();         // %
    float p = bme.readPressure() / 100.0; // hPa

    // Format values (show dashes when invalid)
    String tStr = isnan(t) ? "--.- C" : String(t, 1) + " C";
    String hStr = isnan(h) ? "-- %" : String(h, 0) + " %";
    String pStr = isnan(p) ? "---.- hPa" : String(p, 1) + " hPa";

    drawValue(72, 48, tStr);
    drawValue(72, 78, hStr);
    drawValue(72, 108, pStr);

    // Small heartbeat indicator
    static bool dot = false;
    tft.fillCircle(tft.width() - 12, 12, 4, dot ? TFT_GREEN : TFT_DARKGREY);
    dot = !dot;

    // Serial debug
    Serial.printf("T=%.2f C, H=%.1f %%, P=%.2f hPa\n", t, h, p);
  }
}

----------------------------------------------------------------------PlATFORMIO BESTAND:----------------------
[env:lolin32]
platform = espressif32
board = lolin32
framework = arduino
monitor_speed = 115200

lib_deps =
  bodmer/TFT_eSPI @ ^2.5.43
  adafruit/Adafruit BME280 Library
  adafruit/Adafruit Unified Sensor

build_flags =
  -DUSER_SETUP_LOADED
  -DILI9341_DRIVER
  -DTFT_WIDTH=240
  -DTFT_HEIGHT=320
  -DTFT_MOSI=23
  -DTFT_MISO=19
  -DTFT_SCLK=18
  -DTFT_CS=5
  -DTFT_DC=27
  -DTFT_RST=33
  -DSPI_FREQUENCY=27000000
  -DLOAD_GLCD=1
  -DLOAD_FONT2=1
  -DLOAD_GFXFF=1
